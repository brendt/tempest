#!/usr/bin/env php
<?php

/**
 * Though this script attempts to simplify, it borrows heavily from Symfony's approach.
 *
 * @see https://github.com/symfony/symfony/blob/7.2/.github/build-packages.php
 */

$tempestPackages = json_decode(
        json: exec(__DIR__  . '/get-packages'),
        associative: true
);

$composerPackages = [];

exec(
    "git diff --name-only origin/main...HEAD | grep src/Tempest | sed -E 's|^src/Tempest/([^/]+)/.*|\\1|' | sort -u",
    $changedPackagesArray
);

var_dump($changedPackagesArray);

// NOTE: We will need to change this if we ever have another level of packages.
// I don't envision this though.
foreach ($changedPackagesArray as $changedPackage) {
    $changedPackage = trim($changedPackage);
    $packageDirectory = __DIR__ . '/../src/Tempest/' . $changedPackage;

    // Bundle the current package as a tar file.
    passthru(sprintf("cd \"%s\" && tar -cf package.tar --exclude='package.tar' *", $packageDirectory));

    // Write this package information to "packages.json."
    $composerPath = sprintf('%s/composer.json', $packageDirectory);
    $composerFile = json_decode(file_get_contents($composerPath), true);

    // TODO: Update this version.
    $composerFile['version'] = 'dev-main';
    $composerFile['dist']['type'] = 'tar';
    $composerFile['dist']['source'] = $packageDirectory . '/package.tar';

    // Load the packages from the root "packages.json" file we will write in a second.
    $composerFile['repositories'] = [
        [
            'type' => 'composer',
            'url' => realpath(__DIR__ . '/../'),
        ]
    ];

    file_put_contents($composerFile, json_encode($composerFile, JSON_PRETTY_PRINT));

    // Add the package details to the root "packages.json."
    $composerPackages[$composerFile['name']][$composerFile['version']] = $composerFile;
}

file_put_contents(__DIR__ . '/../packages.json', json_encode($composerPackages, JSON_PRETTY_PRINT));